---
#
# Emacs installer & config
#
# References
# http://www.plusastra.com/2012/11/installing-emacs-24-on-debian-wheezy.html
# http://www.emacswiki.org/emacs-es/EmacsSnapshotAndDebian
#

#
# Add org-mode pdf export support (942MB of disk space required!)
# Find a lighter alternative.
#  - texlive-latex-base, texlive-latex-recommended, texlive-latex-extra
#

- name: Install git
  apt: pkg=git-core

- name: Install emacs
  apt: name=emacs24

- name: Install cask
  git: repo=https://github.com/cask/cask.git dest=/home/map7/.cask

- name: Set permissions
  file: path=/home/map7/.cask owner=map7 group=map7

- name: Add cask bin PATH to Bash profile
  lineinfile:
    dest=/etc/profile
    regexp=".cask\/bin"
    line='export PATH="/home/map7/.cask/bin:$PATH"'
    state=present    

- name: Copy my setup across
  git: repo=https://github.com/map7/emacs-config.git dest=/home/map7/.emacs.d update=no

- name: Compile my plugins
  command: /home/map7/.cask/bin/cask chdir=/home/map7/.emacs.d

- name: Set permissions
  file: path=/home/map7/.emacs.d owner=map7 group=map7 recurse=yes state=directory

# OLD Way


# - name: Install emacs graphics libraries
#   action: apt pkg={{ item }} state=installed

- name: Run the equivalent of "apt-get update" as a separate step
  apt:
    update_cache: yes

- name: Install Emacs dependencies
  apt:
    pkg: "{{ item }}"
    state: present
    default_release: testing
  with_items:
    - libxaw7-dev
    - libxpm-dev
    - libpng-dev
    - libtiff5-dev
    - libgif-dev
    - libjpeg-dev
    - libgtk2.0-dev
    - libncurses5-dev
    - libdbus-1-dev
    - libxft-dev

# - name: Install requirements for emacs widgets to work
#   apt:
#     pkg: "{{ item }}"
#     state: present
#   with_items:
#     - libwebkitgtk-3.0-0
#     - libwebkitgtk-3.0-dev

- name: Clone Emacs from git master using tag
  git:
    repo: https://github.com/emacs-mirror/emacs.git
    dest: "/home/{{ ansible_ssh_user }}/emacs"
    version: emacs-25.2-rc2
    depth: 1
    update: no

- name: Set permissions for Emacs Git Clone
  file:
    path: "/home/{{ ansible_ssh_user }}/emacs"
    owner: "{{ ansible_ssh_user }}"
    group: "{{ ansible_ssh_user }}"
    recurse: yes
  with_items: "{{ ansible_ssh_user }}"

# - name: Install emacs24
#   command: make install chdir=/tmp/emacs-24.3 creates=/usr/local/bin/emacs
- name: Compile, Configure, Make & Install Emacs
  shell: "{{ item }}"
  with_items:
    - ./autogen.sh
    - ./autogen.sh git
    - ./configure --prefix=/opt/emacs
    - make bootstrap -j4
    - make install
  args:
    chdir: "/home/{{ ansible_ssh_user }}/emacs"
    creates: /opt/emacs/bin/emacs-25.2
    
- name: 'Update alternative: emacs'
  alternatives:
    link: /usr/bin/emacs
    name: emacs
    path: /opt/emacs/bin/emacs-25.2

- name: 'Update alternative: emacsclient'
  alternatives:
    link: /usr/bin/emacsclient
    name: emacsclient
    path: /opt/emacs/bin/emacsclient
    priority: 100 #only works in ansible 2.2

# - name: Link emacs24
#   command: ln -s /opt/emacs24/bin/emacs /usr/local/bin/emacs creates=/usr/local/bin/emacs
# - name: Configure the alternatives
#   command: "{{ item }}"
#   become: yes
#   with_items:
#     - 'update-alternatives --config emacs'
#     - 'update-alternatives --config emacsclient'
- name: Link the alternatives
  command: "{{ item }}"
  become: yes
  with_items:
    - 'update-alternatives --config emacs'
    - 'update-alternatives --config emacsclient'

- name: Copy Emacs User Config From Github
  git:
    repo: "{{ emacs_user_config_github }}"
    dest: "/home/{{ ansible_ssh_user }}/.emacs.d"
    update: no

- name: Set permissions for Emacs User Config
  file:
    path: "/home/{{ ansible_ssh_user }}/.emacs.d"
    owner: "{{ ansible_ssh_user }}"
    group: "{{ ansible_ssh_user }}"
    recurse: yes
  with_items: "{{ ansible_ssh_user }}"
